{% extends 'tupie_app/base.html' %}

{% load static %}
{% block title %}Chat with {{ other_user.username }}{% endblock %}
{% block content %}

<h2 class="mb-4">Chat with {{ other_user.username }}</h2>

<div id="chat-box" class="form-section">
  <div id="message-list">
    {% for msg in conversation.messages.all %}
      <div class="{% if msg.sender == request.user %}text-right{% else %}text-left{% endif %}">
        <p class="inline-block bg-white p-2 rounded shadow-sm mb-1">
          <strong>{{ msg.sender.username }}:</strong> {{ msg.content }} 
          {% if msg.sender == request.user %}
            <small class="text-xs text-gray-500">
              {% if msg.is_read %}✔✔ Read{% else %}✔ Sent{% endif %}
            </small>
          {% endif %}
        </p>
        <small class="text-xs text-gray-500">{{ msg.timestamp|date:"M d, Y H:i" }}</small>
      </div>
    {% empty %}
      <p>No messages yet. Start the conversation!</p>
    {% endfor %}
  </div>

  <form id="chat-form" method="POST" class="item-form" style="margin-top: 20px;">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="cta-btn">Send Message</button>
  </form>
</div>

<!-- Script for AJAX fetching realtime sms -->
<script>
  const conversationId = "{{ conversation.id }}";
  const endpoint = `/messages/ajax-send-fetch/${conversationId}/`;

  function fetchMessages() {
    $.get(endpoint, function(data) {
      $('#message-list').html(data.html);
      $('#message-list').scrollTop($('#message-list')[0].scrollHeight);
    });
  }

  if (!window.messagePolling) {
    window.messagePolling = setInterval(fetchMessages, 3000);
  }

  $('#chat-form').on('submit', function(e) {
    e.preventDefault();

    $.ajax({
      url: endpoint,
      method: 'POST',
      data: $(this).serialize(),
      success: function(data) {
        $('#message-list').html(data.html);
        $('#chat-form')[0].reset();
        $('#message-list').scrollTop($('#message-list')[0].scrollHeight);
      },
      error: function() {
        alert('Failed to send message.');
      }
    });
  });
</script>

{% endblock %}
