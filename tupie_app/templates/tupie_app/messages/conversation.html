{% extends 'tupie_app/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load humanize %}
{% block title %}Chat with {{ other_user.username }}{% endblock %}
<script src="{% static 'tupie_app/js/jquery.min.js' %}" defer></script>
<script src="{% static 'tupie_app/js/bootstrap.bundle.min.js' %}" defer></script>

{% block content %}
<section class="page-section container">
<h2 class="mb-4">Chat with {{ other_user.username }}</h2>

<div id="chat-box" class="border rounded shadow-sm p-3 bg-light"
     style="max-width: 800px; margin: auto; height: 70vh; display: flex; flex-direction: column;">

  <!-- Messages -->
  <div id="message-list" class="flex-grow-1 overflow-auto mb-3">
    {% include "tupie_app/messages/_messages_partial.html" %}
  </div>

  <!-- Send form -->
  <form id="chat-form" method="POST" class="d-flex align-items-center">
    {% csrf_token %}
    {{ form.content|as_crispy_field }}
    <button type="submit" class="btn btn-primary ms-2">Send</button>
  </form>

</div>
</section>


<script>
  const conversationId = "{{ conversation.id }}";
  const endpoint = `/messages/ajax-send-fetch/${conversationId}/`;

  function fetchMessages() {
    $.get(endpoint, function(data) {
      $('#message-list').html(data.html);
      $('#message-list').scrollTop($('#message-list')[0].scrollHeight);
    });
  }

  if (!window.messagePolling) {
    window.messagePolling = setInterval(fetchMessages, 3000);
  }

  $('#chat-form').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
      url: endpoint,
      method: 'POST',
      data: $(this).serialize(),
      success: function(data) {
        $('#message-list').html(data.html);
        $('#chat-form')[0].reset();
        $('#message-list').scrollTop($('#message-list')[0].scrollHeight);
      },
      error: function() {
        alert('Failed to send message.');
      }
    });
  });

  // Auto scroll to bottom on load
  document.addEventListener("DOMContentLoaded", function() {
    $('#message-list').scrollTop($('#message-list')[0].scrollHeight);
  });
</script>


{% endblock %}
